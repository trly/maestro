name: Release

on:
  push:
    tags: ["v[0-9]+.[0-9]+.[0-9]+*"]

concurrency:
  group: release-${{ github.sha }}
  cancel-in-progress: false

jobs:
  verify-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Wait for CI to complete
        id: ci-run
        run: |
          echo "Waiting for CI workflow to complete for commit ${{ github.sha }}..."
          TIMEOUT=3600
          ELAPSED=0
          INTERVAL=30

          while [ $ELAPSED -lt $TIMEOUT ]; do
            RUN_ID=$(gh run list --workflow=ci.yml --commit=${{ github.sha }} --json databaseId,status,conclusion --jq '.[] | select(.status=="completed" and .conclusion=="success") | .databaseId' | head -n1)
            
            if [ -n "$RUN_ID" ]; then
              echo "Found successful CI run: $RUN_ID"
              echo "run-id=$RUN_ID" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            FAILED_RUN=$(gh run list --workflow=ci.yml --commit=${{ github.sha }} --json conclusion --jq '.[] | select(.conclusion=="failure" or .conclusion=="cancelled") | .conclusion' | head -n1)
            if [ -n "$FAILED_RUN" ]; then
              echo "::error::CI workflow failed or was cancelled for commit ${{ github.sha }}"
              exit 1
            fi
            
            echo "CI still running, waiting ${INTERVAL}s... (${ELAPSED}s elapsed)"
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          echo "::error::Timeout waiting for CI to complete after ${TIMEOUT}s"
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Linux build artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: ./builds/linux
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.ci-run.outputs.run-id }}

      - name: Download macOS build artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: ./builds/macos
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.ci-run.outputs.run-id }}

      - name: Download macOS ZIP artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-zip
          path: ./builds/macos
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.ci-run.outputs.run-id }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          prerelease: true
          files: |
            builds/linux/**/*.deb
            builds/macos/**/*.dmg
            builds/macos/*.zip
          generate_release_notes: true
          fail_on_unmatched_files: true

      - name: Update Homebrew Tap
        run: |
          # Extract version from tag (v0.4.5 -> 0.4.5)
          VERSION="${GITHUB_REF_NAME#v}"
          echo "Updating Homebrew tap for version $VERSION"
          
          # Find the checksum file (pre-calculated during CI build)
          SHA256_FILE=$(find builds/macos -name "Maestro.app.zip.sha256" -type f | head -n1)
          if [ -z "$SHA256_FILE" ]; then
            echo "::error::SHA256 checksum file not found"
            exit 1
          fi
          
          # Read SHA256 from file
          SHA256=$(cat "$SHA256_FILE")
          echo "Using pre-calculated SHA256: $SHA256"
          
          # Clone the tap repository
          git clone https://x-access-token:${GH_TOKEN}@github.com/trly/homebrew-maestro.git tap-repo
          cd tap-repo
          
          # Update version and SHA256 in the cask file
          CASK_FILE="Casks/maestro.rb"
          sed -i.bak "s/version \".*\"/version \"$VERSION\"/" "$CASK_FILE"
          sed -i.bak "s/sha256 \".*\"/sha256 \"$SHA256\"/" "$CASK_FILE"
          rm "${CASK_FILE}.bak"
          
          # Check if changes were made
          if git diff --quiet "$CASK_FILE"; then
            echo "No changes to Homebrew cask"
            exit 0
          fi
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Commit and push to tap repository
          git add "$CASK_FILE"
          git commit -m "maestro $VERSION"
          git push origin main
          
          echo "âœ… Homebrew tap updated to version $VERSION"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}